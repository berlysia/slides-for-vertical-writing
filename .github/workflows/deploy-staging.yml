name: Deploy Cloudflare Worker (Staging)

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# æœ€å°æ¨©é™ã®è¨­å®š
permissions:
  contents: read
  id-token: write
  pull-requests: read

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ - stagingç’°å¢ƒã‚‚1ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã¿è¨±å¯
concurrency:
  group: staging-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging-slides-berlysia-net.berlysia.workers.dev
    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1 (SHAå›ºå®š)

      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # v4æœ€æ–°ç‰ˆ
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@0a44ba7841725637a19e28fa30b79a866c81b0a6 # v4.0.4 (SHAå›ºå®š)
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build slides
        run: pnpm run build:all

      - name: Deploy to Cloudflare Workers (Staging)
        uses: cloudflare/wrangler-action@9681c2997648301493e78cacbfb790a9f19c833f # v3.9.0 (SHAå›ºå®š)
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env staging
          workingDirectory: '.'
        env:
          WRANGLER_LOG_LEVEL: warn

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Staging deployment successful"
            echo "ğŸŒ URL: https://staging-slides-berlysia-net.berlysia.workers.dev"
          else
            echo "âŒ Staging deployment failed"
            exit 1
          fi

      - name: Comment PR with deployment info
        if: github.event_name == 'pull_request' && job.status == 'success'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Staging deployment successful!\n\nğŸ“ Preview URL: https://staging-slides-berlysia-net.berlysia.workers.dev'
            })